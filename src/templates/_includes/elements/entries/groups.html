{% import '_includes/forms' as forms %}

{% set sections = element.groups %}

{% set sectionEntryTypes = [] %}

{# Create a section-indexed array of element types #}
{% set entryTypes = [] %}
{% for section in sections %}
    {% set options = craft.feedme.getSelectOptions(section.model.getEntryTypes(), 'name', 'uid') %}
    {# We have to prefix the index, otherwise Twig doesn't maintain numbered index correctly #}
    {% set entryTypes = entryTypes|merge({ ('item_' ~ section.model.uid): options }) %}
{% endfor %}

{% set sectionUid = null %}
{% set entryTypeUid = null %}

{# Load saved values for feed #}
{% if feed.elementGroup[elementType] is defined %}
    {% set sectionUid = feed.elementGroup[elementType].section ?? null %}
    {% set entryTypeUid = feed.elementGroup[elementType].entryType ?? null %}
{% endif %}

{% if sectionUid %}
    {% set section = craft.app.sections.getSectionByUid(sectionUid) %}
    {% if section %}
        {% set sectionEntryTypes = section.getEntryTypes() %}
    {% endif %}
{% elseif sections[0] is defined %}
    {% set sectionEntryTypes = sections[0].model.getEntryTypes() ?? null %}
{% endif %}

<div class="element-sub-group" data-items="{{ entryTypes|json_encode }}">
    {{ forms.selectField({
        label: "Section"|t('feed-me'),
        instructions: 'Choose the Section you want to save your feed data to.'|t('feed-me'),
        class: 'element-parent-group',
        id: 'elementGroup-' ~ elementType ~ '-section',
        name: 'elementGroup[' ~ elementType ~ '][section]',
        options: craft.feedme.getSelectOptions(sections|map(s => s.model), 'name', 'uid'),
        value: sectionUid ?? '',
        errors: feed.getErrors('elementGroup'),
        required: true,
    }) }}

    {{ forms.selectField({
        label: "Entry Type"|t('feed-me'),
        instructions: 'Choose the Entry Type you want to save your feed data into.'|t('feed-me'),
        class: 'element-child-group',
        id: 'elementGroup-' ~ elementType ~ '-entryType',
        name: 'elementGroup[' ~ elementType ~ '][entryType]',
        options: craft.feedme.getSelectOptions(sectionEntryTypes, 'name', 'uid'),
        value: entryTypeUid ?? '',
        errors: feed.getErrors('elementGroup'),
        required: true,
    }) }}
</div>
